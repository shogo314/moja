セグ木にmapをのせる方法を想定しています。更新時は通常のセグ木のままだと駄目で、少しいじる必要があります。

計算量は $O(N+Q(logN)^2)$ でかなり通りずらいので $N$ と $Q$ が微妙な値になってしまいました。
